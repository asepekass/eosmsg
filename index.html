<!DOCTYPE html>
<html>
  
  <head>
    <meta charset="utf-8">
    
    <title>EOSMsg</title>
    <!-- <link rel="shortcut icon" href="favicon.ico"> -->
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">
    
    <!--Import Google Icon Font-->
    <style>
      /* fallback */
      
      @font-face {
      font-family: 'Material Icons';
      font-style: normal;
      font-weight: 400;
      src: url(/fonts/fontsdownloads.woff2) format('woff2');
      }
      
      .material-icons {
	  font-family: 'Material Icons';
	  font-weight: normal;
	  font-style: normal;
	  font-size: 24px;
	  line-height: 1;
	  letter-spacing: normal;
	  text-transform: none;
	  display: inline-block;
	  white-space: nowrap;
	  word-wrap: normal;
	  direction: ltr;
	  -moz-font-feature-settings: 'liga';
	  -moz-osx-font-smoothing: grayscale;
      }
      
      nav {
	  background-color: #215968;
      }
      
      .btn,
      .btn-large {
	  background-color: #338968;
      }
      
      .brand-logo {
	  margin-left: 40px;
      }
    </style>
    
  </head>
  
  <body style="min-width: 640px;">
    <div id="menuNav" style="display:none;">
      <nav>
	<div class="nav-wrapper">
	  <a href="#!" class="brand-logo">EOSMsg</a>
	  <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
	  <ul class="right hide-on-med-and-down">
	    <li><a href="javascript:gotoView('contactsView');">Messages<span class="new badge red navBadgetMsgs" style="display:none;">0</span></a></li>
	    <li><a href="javascript:gotoView('dappsView');">DApps</a></li>
	    <!-- <li><a href="javascript:gotoView('settingsView');">Settings</a></li>
		 <li><a href="#">Lock</a></li> -->
	  </ul>
	</div>
      </nav>
      
      <ul class="sidenav" id="mobile-demo">
	<li><a href="javascript:gotoView('contactsView');">Messages<span class="new badge red navBadgetMsgs" style="display:none;">0</span></a></li>
	<li><a href="javascript:gotoView('dappsView');">DApps</a></li>
	<!-- <li><a href="javascript:gotoView('settingsView');">Settings</a></li>
	     <li><a href="#">Lock</a></li> -->
      </ul>
    </div>
    
    
    <div id="barprogress" class="progress" style="display:none;">
      <div class="indeterminate"></div>
    </div>
    
    <div id="content" class="container">
      <!-- Setup -->
      <div class="view" id="setupView" style="display:none;">
        <h1>Setup</h1>
	
        <div class="row">
          <form class="col s12">
            <div class="row">
              <div class="input-field col s12">
                <input id="setupAccountName" type="text" class="validate">
                <label for="setupAccountName">Account Name</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s12">
                <input id="keypriv" type="password" class="validate">
                <label for="keypriv">Private Key</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s12">
                <input disabled id="keypub" type="text" class="validate">
                <label for="keypub">Public Key</label>
              </div>
            </div>
	    
	    
            <div class="row">
              <div class="input-field col s12">
                <input id="pass1" type="password" class="validate">
                <label for="pass1">Password</label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s12">
                <input id="pass2" type="password" class="validate">
                <label for="pass2">Password again</label>
              </div>
            </div>
          </form>
          <button id="setupButton" class="btn waves-effect waves-light" name="action">Submit
            <i class="material-icons right">send</i>
          </button>
        </div>
	
      </div>
      
      <!-- Unlock -->
      <div class="view" id="unlockView" style="display:none;">
        <h1>Unlock</h1>
	
        <div class="row">
          <form class="col s12">
            <div class="row">
              <div class="input-field col s12">
                <input id="passUnlock" type="password" class="validate">
                <label for="passUnlock">Password</label>
              </div>
            </div>
          </form>
          <button id="unlockButton" class="btn waves-effect waves-light" name="action">Unlock
            <i class="material-icons right">send</i>
          </button>
        </div>
      </div>
      
      <!-- Contacts -->
      <div class="view" id="contactsView" style="display:none;">
	
	<div id="myinfo" class="row" style="display:none;"></div>
	
	<h4>My Contacts</h4>
        <div class="collection" id="listContacts">
          <!-- <a href="#!" class="collection-item">Alvin</a> -->
        </div>
	
        <div class="fixed-action-btn">
          <a class="btn-floating btn-large waves-effect waves-light red modal-trigger" href="#addContactModal">
            <i class="large material-icons">add</i>
          </a>
        </div>
	
        <div id="msgNoContacts"  class="card-panel grey">
          Your contact list is empty. Use the plus button to add your contacts.
	</div>
	
        <!-- Modal Structure -->
        <div id="addContactModal" class="modal">
          <div class="modal-content">
            <h4>New Contact</h4>
            <div class="row">
              <div class="input-field col s12">
                <input id="inputNewContact" type="text" class="validate">
                <label for="inputNewContact">Account name</label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <a href="javascript:addNewContact()" class="modal-close waves-effect waves-green btn-flat">Add</a>
          </div>
        </div>
	
      </div>
      
      <!-- Conversation -->
      <div class="view" id="conversationView" style="display:none;">
	<br/>
 	<a class="waves-effect waves-light btn-small" id="btnConversationBack">Back</a>
	
	<div id="toinfo" class="row" style="display:none;"></div>
	
	<h5 id="conversationTitle">Conversation</h5>
	
	<div class="row">
          <div class="input-field col s10 m10">
            <input id="inputSend" type="text" class="validate">
          </div>
          <button id="sendButton" class="btn  btn-large waves-effect waves-light col s2 m2 " name="action">Send
            <i class="material-icons right">send</i>
          </button>
        </div>
	
        <div id="listMessages">
        </div>
	
      </div>
      
      <!-- No storage -->
      <div class="view" id="noStorageView" style="display:none;">
        <h3>Storage is not supported by you browser. Sorry!</h3>
      </div>
      
      
      <!-- DApps view -->
      <div class="view" id="dappsView" style="display:none;">
	<div id="listDApps" class="row">
	  <div class="col s6 m4">
	    <div class="card">
	      <div class="card-image waves-effect waves-block waves-light">
		<img class="activator" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQul3s1Bzff2aUmfb-9EqPVQRNN44q9Ur8yrP3wrkNAzKSfB_WS">
	      </div>
	      <div class="card-content">
		<span class="card-title activator grey-text text-darken-4"  style='font-size: 16px;'>Hot DApps</span>
	      </div>
	      <div class="card-reveal">
		<span class="card-title grey-text text-darken-4">DApps Suggestions<i class="material-icons right">close</i></span>
		<p>Here you can know dapps integrated into EOSMsg, enjoy!!</p>
	      </div>
	      <div class="card-action">
		<a href="javascript:gotoView('suggestionsView');">Go to</a>
	      </div>
	    </div>
	  </div>
	</div>
	
        <!-- Modal Structure -->
        <div id="addDAppModal" class="modal">
          <div class="modal-content">
            <h4>New DApp</h4>
            <div class="row">
              <div class="input-field col s12">
                <input id="inputNewDApp" type="text" class="validate">
                <label for="inputNewDApp">URL to DApp</label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <a href="javascript:addNewDApp()" class="modal-close waves-effect waves-green btn-flat">Add</a>
          </div>
        </div>
	
        <div class="fixed-action-btn">
          <a class="btn-floating btn-large waves-effect waves-light red modal-trigger" href="#addDAppModal">
            <i class="large material-icons">add</i>
          </a>
        </div>
      </div>
      
      <!-- Settings view -->
      <div class="view" id="settingsView" style="display:none;">
	<h1>Settings</h1>
      </div>
      
      <!-- DApp view -->
      <div class="view" id="dappView" style="display:none;">
        <br/>
        <div id="divappiframe" class="row">
          <iframe id="appiframe" style="border: 0px;"></iframe>
        </div>
	
        <!-- Modal Structure Transfer -->
        <div id="transferModal" class="modal bottom-sheet">
          <div class="modal-content">
            <h4>Transfer</h4>
            <p>The DApp is trying make a transfer from your account</p>
            <table class="striped">
              <tr><td>From</td><td><span id="transferFrom"></span></td></tr>
              <tr><td>To</td><td><span id="transferTo"></span></td></tr>
              <tr><td>Amount</td><td><span id="transferAmount"></span></td></tr>
              <tr><td>Memo</td><td><span id="transferMemo"></span></td></tr>
            </table>
          </div>
          <div class="modal-footer">
            <a id="btnAcceptTransfer" class="modal-close waves-effect waves-green btn-flat">Accept</a>
            <a id="btnDenyTransfer" class="modal-close waves-effect waves-green btn-flat">Deny</a>
          </div>
        </div>
	
        <!-- Modal Structure Action -->
        <div id="actionModal" class="modal bottom-sheet">
          <div class="modal-content">
            <h4>Action</h4>
            <p>The DApp is trying make a action from your account</p>
            <table class="striped">
              <tr><td>Contract</td><td><span id="actionContract"></span></td></tr>
              <tr><td>Action</td><td><span id="actionAction"></span></td></tr>
              <tr><td>Authorization</td><td><span id="actionAuthorization"></span></td></tr>
              <tr><td>Data</td><td><span id="actionData"></span></td></tr>
            </table>
          </div>
          <div class="modal-footer">
            <a id="btnAcceptAction" class="modal-close waves-effect waves-green btn-flat">Accept</a>
            <a id="btnDenyAction" class="modal-close waves-effect waves-green btn-flat">Deny</a>
          </div>
        </div>
	
      </div>
      
      <!-- Suggestions dapps -->
      <div class="view" id="suggestionsView" style="display:none;">
	<br/>
	<a class="waves-effect waves-light btn-small" id="btnSuggestionsBack">Back</a>
	<h4>DApps Suggestions</h4>
	
	
	<div class="row">
	  <div class="col s6 m4">
	    <div class="card">
	      <div class="card-image waves-effect waves-block waves-light">
		<img class="activator" src="https://www.revelacoes.net/wp-content/uploads/2018/02/o-aviso-1.png" >
		<span class="card-title red">Not integrated</span>
	      </div>
	      <div class="card-content">
		<span class="card-title activator grey-text text-darken-4" style='font-size: 16px;'>EOSFlare</span>
	      </div>
	      <div class="card-reveal">
		<span class="card-title grey-text text-darken-4">EOSFlare<i class="material-icons right">close</i></span>
		<p>A EOS network monitor.</p>
	      </div>
	      <div class="card-action installAction" >
		<a class="eosflare" href="javascript:installDApp('eosflare.json')">Install</a>
	      </div>
	    </div>
	  </div>
	  
	  <div class="col s6 m4">
	    <div class="card">
	      <div class="card-image waves-effect waves-block waves-light">
		<img class="activator" src="http://www.montanascreensavers.com/wp-content/uploads/2018/03/Football-Match-Prediction-300x300.jpg" >
	      </div>
	      <div class="card-content">
		<span class="card-title activator grey-text text-darken-4" style='font-size: 16px;'>Simple Game</span>
	      </div>
	      <div class="card-reveal">
		<span class="card-title grey-text text-darken-4">GoalbarClub Simple Game<i class="material-icons right">close</i></span>
		<p>A simple game to bet in soccer scores</p>
	      </div>
	      <div class="card-action installAction" >
		<a class="goalbarbeting" href="javascript:installDApp('goalbarbeting.json')">Install</a>
	      </div>
	    </div>
	  </div>
	  
	  <div class="col s6 m4">
	    <div class="card">
	      <div class="card-image waves-effect waves-block waves-light">
		<img class="activator" src="https://cdn.shopify.com/s/files/1/0012/7510/1295/products/cowather_simple_wallet_1_300x300.jpg?v=1531010324" >
	      </div>
	      <div class="card-content">
		<span class="card-title activator grey-text text-darken-4" style='font-size: 16px;'>Simple Wallet</span>
	      </div>
	      <div class="card-reveal">
		<span class="card-title grey-text text-darken-4">Simple Wallet<i class="material-icons right">close</i></span>
		<p>A Simple Wallet to EOS network</p>
	      </div>
	      <div class="card-action installAction" >
		<a class="simplewallet" href="javascript:installDApp('simplewallet.json')">Install</a>
	      </div>
	    </div>
	  </div>
	</div>
      </div>

    </div>
    
    
  </body>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eosjs@16.0.0/lib/eos.min.js" integrity="sha512-vNyLnOEb7uFmEtVbLnyZQ9/k4zckM2Vu3jJOKq6XfWEVZG0yKcjDExVN4EQ7e3F+rePWRncMolI2xFi/3qo62A==" crossorigin="anonymous"></script>
  <script src="blowfish.js"></script>
  
  <script>
    $(document).ready(function() {
	$('.sidenav').sidenav();
	$('#addContactModal').modal();
	$('#transferModal').modal();
	$('#actionModal').modal();
	$('#addDAppModal').modal();
	loadGlobals();
	initApp();
    });
    
  </script>
  
  <script>
    //// EOS ////////////
    var {
	format,
	api,
	ecc,
	json,
	Fcbuffer
    } = Eos.modules;
    
    chain = {
	mainnet: 'aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906',
	testnet: '038f4b0fc8ff18a4f0842a8f0564611f6e96e8535901dd45e43ac8691a1c4dca',
	sysnet: 'cf057bbfb72640471fd910bcb67639c22df9f92470936cddc1ade0e2f2e7dc4f'
    };
    
    /**
       Other httpEndpoint's: https://www.eosdocs.io/resources/apiendpoints
    */
    eosconfig = {
	///httpEndpoint: 'http://192.168.0.105:8800',
	///chainId: chain.sysnet,
	httpEndpoint: 'https://mainnet.eoscanada.com',
	chainId: chain.mainnet,
	broadcast: true,
	keyProvider: "",
	verbose: false,
    };
    
    var contract_account = "eosdirectmsg";
    eos = Eos(eosconfig);
    
    //// Navigation //////////
    var tbContacts = [];
    var dapps = [];
    var accountname = "";
    var currentDApp = "";
    var currentTo = "";
    
    function loadGlobals() {
	var strTbContacts = localStorage.getItem("tbContacts");
	tbContacts = JSON.parse(strTbContacts);
	if (tbContacts == null)
	    tbContacts = [];
	
	var strDApps = localStorage.getItem("DApps");
	dapps = JSON.parse(strDApps);
	if (dapps == null)
	    dapps = [];
	
	accountname = localStorage.getItem("accountname");
    }
    
    //// Navigation //////////
    function initApp() {
	if (typeof(Storage) !== "undefined") {
	    var eoskeyenc = localStorage.getItem("keyprivenc");
	    if (eoskeyenc == null) {
		gotoView("setupView");
	    } else {
		gotoView("unlockView");
	    }
	} else {
	    gotoView("noStorageView");
	}
    }
    
    function loadContentInIFrame(content){
	$("#divappiframe").html("");
	$("#divappiframe").html("<iframe id='appiframe' style='border: 0px;' class='col s12 m12'></iframe>");
	
	var iframe = document.getElementById('appiframe');
	
	var doc = iframe.contentWindow.document;
	doc.open();
	doc.write(content);
	doc.close();
	
	iframe.style.height = ($(document).height() - 64)  + 'px';
    }
    
    function loadRemoteInIFrame(url){
	loadContentInIFrame("");
	$("#appiframe").attr('src',url);
    }
    
    function renderNoop() {}
    
    function renderContacts() {
	$("#menuNav").show();
	renderAccountInfoCardOn(accountname, "myinfo");
	writeListContacts();
    }
    
    function renderAccountInfoCardOn(acc, div) {
	$("#" + div).hide();
	eos.getAccount(acc).then(res => {
	    console.log(res);
	    $("#" + div).html(
		"<div class='col s12 m12'>" +
		    "    <div class='card blue-grey darken-1'>" +
		    "        <div class='card-content white-text'> " +
		    "            <span class='card-title'>" + acc + " - (" + res.created + ")</span>" +
		    "                <p> <b>RAM Quota: </b>" + res.ram_quota + " - <b>RAM usage: </b> " + res.ram_usage + " </p>" +
		    "                <p> <b>CPU used: </b>" + res.cpu_limit.used + " - <b>CPU available: </b> " + res.cpu_limit.available + " - <b>CPU max: </b> " + res.cpu_limit.max + " </p>" +
		    "                <p> <b>Net used: </b>" + res.net_limit.used + " - <b>Net available: </b> " + res.net_limit.available + " - <b>Net max: </b> " + res.net_limit.max + " </p>" +
		    "        </div> " +
		    "       <div class='card-action'>" +
		    "          <a href='https://eosflare.io/account/" + acc + "' target='_blank'>eosflare</a>" +
		    "          <a href='https://eosweb.net/account/" + acc + "' target='_blank'>EOSweb</a>" +
		    "          <a href='https://bloks.io/account/" + acc + "' target='_blank'>EOS Bloks</a>" +
		    "       </div>" +
		    "    </div>" +
		    "</div>");
	    $("#"+div).show();
	});
    }
    
    function renderConversationAll() {
	renderAccountInfoCardOn(currentTo, "toinfo");
    }
    
    function renderConversation() {
	$("#menuNav").show();
	$("#conversationTitle").html("Conversation with " + currentTo);
	$("#listMessages").html("");
	
	for (var i in tbContacts) {
	    var con = tbContacts[i];
	    if (con.Name == currentTo) {
		for (var m in con.Messages) {
		    
		    switch(con.Messages[m].state) {
		    case "tosend":
			$("#listMessages").prepend(
			    "<div class='row'>" +
				"   <div class='col s6 m6 offset-s6 offset-m6'> " +
				"                <div class='card-panel purple'>" +
				"                    <span class='black-text'>" + con.Messages[m].content + "</span> <i class='material-icons'>access_time</i>" +
				"                </div>" +
				"   </div>" +
				"</div>");
			break;
		    case "sent":
			$("#listMessages").prepend(
			    "<div class='row'>" +
				"   <div class='col s6 m6 offset-s6 offset-m6'> " +
				"                <div class='card-panel indigo'>" +
				"                    <span class='black-text'>" + con.Messages[m].content + "</span> <i class='material-icons'>done</i>" +
				"                </div>" +
				"   </div>" +
				"</div>");
			break;
		    case "erased":
			$("#listMessages").prepend(
			    "<div class='row'>" +
				"   <div class='col s6 m6 offset-s6 offset-m6'> " +
				"                <div class='card-panel red'>" +
				"                    <span class='black-text'>" + con.Messages[m].content + "</span> <i class='material-icons'>clear</i>" +
				"                </div>" +
				"   </div>" +
				"</div>");
			break;
		    case "read":
			$("#listMessages").prepend(
			    "<div class='row'>" +
				"   <div class='col s6 m6'> " +
				"          <div class='card-panel lime'> " +
				"               <span class='white-text'>" + con.Messages[m].content + "</span> <i class='material-icons'>chrome_reader_mode</i>" +
				"          </div>"+
				"  </div>"+
				"</div>");
			break;
		    case "notify":
			break;
		    case "received":
			$("#listMessages").prepend(
			    "<div class='row'>" +
				"   <div class='col s6 m6'> " +
				"          <div class='card-panel green'> " +
				"               <span class='white-text'>" + con.Messages[m].content + "</span> <i class='material-icons'>done_all</i>" +
				"          </div>"+
				"  </div>"+
				"</div>");
			break;
		    default:
			console.log("DEFAULT render");
		    }
		    
		} 
		break;
	    }
	}
    }
    
    function gotoDApp(app) {
	currentDApp = app;
	gotoView("dappView");
    }
    
    function renderDApps () {
	$("#listDApps > .installed").remove();
	for(var i in dapps) {
	    var kapp = dapps[i];
	    
	    var strapp = localStorage.getItem(kapp);
	    app = JSON.parse(strapp);
	    if (dapps == null) {
		M.toast({html: "Error loading " + kapp});
		continue;
	    }
	    
	    $("#listDApps").append(
		"<div class='col s6 m4 installed'> " +
		    "   <div class='card'>"+
		    "      <div class='card-image waves-effect waves-block waves-light'>" +
		    "            <img class='activator' src='" + app.image + "' >" +
		    (app.support?"":"            <span class='card-title red'>Not integrated</span>") +
		    "       </div>" +
		    "       <div class='card-content'>" +
		    "            <span class='card-title activator grey-text text-darken-4'  style='font-size: 16px;'>" + app.name + "</span>" +
		    "       </div>" +
		    "       <div class='card-reveal'>"+
		    "           <span class='card-title grey-text text-darken-4'>" + app.name + "<i class='material-icons right'>close</i></span>"+
		    "           <p>" + app.description + "</p>"+
		    "       </div>"+
		    "       <div class='card-action'>"+
		    "          <a href=\"javascript:gotoDApp('" + kapp + "');\">Run</a>" +
		    //"          <a href=\"javascript:gotoView('dappView');\">Remove</a>" +
		    "       </div>"+
		    "   </div>"+
		    " </div>");
	    
	}
    }
    
    function renderSuggestions() {
	$(".installAction").show();
	for(var i in dapps) {
	    $("."+dapps[i]).html("Reinstall");
	}
    }
    
    function renderDApp() {
	var strApp = localStorage.getItem(currentDApp);
	var app = JSON.parse(strApp);
	if (app == null) {
	    M.toast({html: "Error loading " + currentDApp});
	    return;
	}
	
	if (app.remote) {
	    loadRemoteInIFrame(app.contenturl);
	} else {
	    M.toast({html: "Local load still not implemented"});
	    ///loadContentInIFrame
	}
    }
    
    var panels = {
	"setupView" : renderNoop,
	"noStorageView": renderNoop,
	"conversationView": renderConversationAll,
	"contactsView": renderContacts,
	"dappsView": renderDApps,
	"dappView": renderDApp,
	"settingsView": renderNoop,
	"suggestionsView": renderSuggestions,
    };
    
    function gotoView(view) {
	stopIFrame();
	var rfn = panels[view];
	if (rfn != undefined) {
	    rfn();
	}
	
	$(".view").hide();
	$("#" + view).show();
    }
    
    //////////////// EVENTS  ///////////////
    function goodPassword(pw) {
	if (pw.length < 8) return false;
	return true;
    }
    
    $("#keypriv").blur(function() {
	var eoskeypriv = $("#keypriv").val();
	if (!ecc.isValidPrivate(eoskeypriv)) {
	    $("#keypriv").val("");
	    $("#keypub").val("");
	    
	    M.toast({
		html: 'Invalid Private Key!'
	    });
	    return;
	}
	
	var eoskeypub = ecc.privateToPublic(eoskeypriv);
	$("#keypub").val(eoskeypub);
	M.updateTextFields();
    });
    
    var bfish = null;
    
    $("#setupButton").on("click", function() {
	var eoskeypriv = $("#keypriv").val();
	var eoskeypub = $("#keypub").val();
	var accountname = $("#setupAccountName").val();
	var pass1 = $("#pass1").val();
	var pass2 = $("#pass2").val();
	
	if (!ecc.isValidPrivate(eoskeypriv)) {
	    $("#keypriv").val("");
	    $("#keypub").val("");
	    
	    M.toast({
		html: 'Invalid Private Key!'
	    });
	    return;
	}
	
	if (pass1 != pass2) {
	    $("#pass1").val("");
	    $("#pass2").val("");
	    
	    M.toast({
		html: 'Passwords not match!'
	    });
	    return;
	}
	
	if (!goodPassword(pass1)) {
	    $("#pass1").val("");
	    $("#pass2").val("");
	    
	    M.toast({
		html: 'Weak password!'
	    });
	    return;
	}
	
	bfish = new Blowfish(pass1);
	var keyprivenc = bfish.encrypt(eoskeypriv);
	
	localStorage.setItem("keyprivenc", keyprivenc);
	localStorage.setItem("keypub", eoskeypub);
	localStorage.setItem("accountname", accountname);
	
	gotoView("unlockView");
    });
    
    function handleUnlock() {
	var pass = $("#passUnlock").val();
	var keyprivenc = localStorage.getItem("keyprivenc");
	
	bfish = new Blowfish(pass);
	var decrypted = bfish.decrypt(keyprivenc);
	eoskeypriv = bfish.trimZeros(decrypted); // for string/text information
	
	if (!ecc.isValidPrivate(eoskeypriv)) {
	    $("#passUnlock").val("");
	    
	    M.toast({
		html: 'Wrong Password!'
	    });
	    return;
	}
	
	eosconfig.keyProvider = eoskeypriv;
	eos = Eos(eosconfig);
	
	setTimeout(getMessagesToMe, 3000);
	setTimeout(processMessage, 1000);
	gotoView("contactsView");
    }
    $("#unlockButton").on("click", handleUnlock);
    
    function writeListContacts() {
	$("#listContacts").html("");
	$("#msgNoContacts").hide();
	if (tbContacts.length == 0) {
	    $("#msgNoContacts").show();
	}
	
	for (var i in tbContacts) {
	    var con = tbContacts[i];
	    var unread = tbContacts[i].unread;
	    
	    if (unread == undefined) {
		$("#listContacts").append("<a href='javascript:openConversation(" + i + ")' class='collection-item'>" + con.Name + "</a>");
	    } else {
		$("#listContacts").append("<a href='javascript:openConversation(" + i + ")' class='collection-item'>" + con.Name + "<span class='new badge red badgelist'>" + unread +  "</span> </a>");
	    }
	}
    }
    
    function addNewContact() {
	var name = $("#inputNewContact").val();
	$("#inputNewContact").val("");
	
	if (accountname == name) {
	    M.toast({
		html: "It's your account name!!",
	    });
	    return;
	}
	
	eos.getAccount(name)
	    .then(res => {
		var contact = {
		    Name:     name,
		    Messages: [],
		};
		tbContacts.push(contact);
		localStorage.setItem("tbContacts", JSON.stringify(tbContacts));
		
		writeListContacts();		
	    })
	    .catch(err => {
		M.toast({
		    html: 'Account name not found!'
		});
	    })
    }
    
    $("#btnConversationBack").click(function() {
	gotoView("contactsView");
    });
    
    $("#btnSuggestionsBack").click(function() {
	gotoView("dappsView");
    });
    
    function openConversation(id) {
	var contact = tbContacts[id];
	currentTo = contact.Name;
	delete tbContacts[id].unread;
	localStorage.setItem("tbContacts", JSON.stringify(tbContacts));
	
	gotoView("conversationView");
    }
    
    $("#sendButton").click(function() {
	var text = $("#inputSend").val();
	
	if (text.length > 0) {
	    for (var i in tbContacts) {
		var con = tbContacts[i];
		if (con.Name == currentTo) {
		    con.Messages.push({
			content: text,
			createdat: Date.now(),
			to: currentTo,
			state: "tosend",
		    });
		    tbContacts[i] = con;
		    localStorage.setItem("tbContacts", JSON.stringify(tbContacts));
		    break;
		}
	    }
	    
	    $("#listMessages").prepend(
		"<div class='row'>" +
		    "   <div class='col s6 m6 offset-s6 offset-m6'> " +
		    "                <div class='card-panel purple'>" +
		    "                    <span class='black-text'>" + text + "</span> <i class='material-icons'>access_time</i>" +
		    "                </div>" +
		    "   </div>" +
		    "</div>");
	    
	    $("#inputSend").val("");
	}
    });
    
    function processMessageToSend(idxcon, idxmsg) {
	console.log("STATUS: tosend - " + idxcon, idxmsg);
	
	var con = tbContacts[idxcon];
	var msg = con.Messages[idxmsg];
	
	eos.contract(contract_account).then(contract =>
					    contract.sendmsg({
						from: accountname,
						to: currentTo,
						msg: msg.content,
					    }, {
						authorization: accountname
					    })).then(function() {
						console.log("OK");
						tbContacts[idxcon].Messages[idxmsg].state = "sent";
						
						localStorage.setItem("tbContacts", JSON.stringify(tbContacts));
					    }).catch(function(exception) {
						console.log(exception);
						/*if (exception) {
						  M.toast({
						  html: exception
						  });
						  }*/
					    });
    }
    
    function processMessageRead(idxcon, idxmsg){
	var ID = tbContacts[idxcon].Messages[idxmsg].id;
	
	eos.contract(contract_account).then(contract =>
					    contract.receivemsg({
						to: accountname,
						id: ID,
					    }, {
						authorization: accountname
					    })).then(function() {
						console.log("ok");
						tbContacts[idxcon].Messages[idxmsg].state = "received";
						delete tbContacts[idxcon].Messages[idxmsg].id;
						
						localStorage.setItem("tbContacts", JSON.stringify(tbContacts));
					    });
    }
    
    function processMessageNotify(idxcon, idxmsg){
	var ID = tbContacts[idxcon].Messages[idxmsg].id;
	var from = tbContacts[idxcon].Messages[idxmsg].from;
	
	eos.getTableRows({
	    "json": true,
	    "scope": from,
	    "code": contract_account,
	    "table": "message",
	    "limit": 1,
	    "lower_bound": ID,
	}).then(result => {
	    console.log(result);
	    tbContacts[idxcon].Messages[idxmsg].content = result.rows[0].text;
	    tbContacts[idxcon].Messages[idxmsg].createdat = result.rows[0].send_at;
	    tbContacts[idxcon].Messages[idxmsg].type = result.rows[0].type;
	    tbContacts[idxcon].Messages[idxmsg].state = "read";
	    
	    if (tbContacts[idxcon].unread == undefined) {
		tbContacts[idxcon].unread = 1;
	    } else {
		tbContacts[idxcon].unread ++;
	    }
	    
	    localStorage.setItem("tbContacts", JSON.stringify(tbContacts));
	}).catch(function(exception) {
	    if (exception) {
		alert(exception);
	    }
	});
    }
    
    function refreshPanels() {
	writeListContacts();
	renderConversation();
    }
    
    function updateNav() {
	var bl = $(".badgelist");
	
	var total = 0;
	for (var i = 0; i < bl.length; i++) {
	    total += parseInt(bl[i].innerText);
	}
	
	if (total == 0) {
	    $(".navBadgetMsgs").hide();
	} else {
	    $(".navBadgetMsgs").html("" + total);
	    $(".navBadgetMsgs").show();
	}
    }
    
    function processMessage() {
	console.log("processMessage");
	loadGlobals();
	updateNav();
	
	for (var i in tbContacts) {
	    var con = tbContacts[i];
	    for (var m in con.Messages) {
		var msg = con.Messages[m];
		
		switch(msg.state) {
		case "tosend":
		    console.log("TOSEND");
		    processMessageToSend(i, m);
		    break;
		case "read":
		    console.log("READ");
		    processMessageRead(i,m);
		    break;
		case "notify":
		    console.log("NOTIFY");
		    processMessageNotify(i,m);
		    break;
		default:
		    console.log("DEFAULT");
		    console.log(msg.createdat);
		}
	    }
	}
	
	refreshPanels();
	setTimeout(processMessage, 3000);
    }
    
    function hasContact(name) {
	for(var i in tbContacts) {
	    if (tbContacts[i].Name == name) {
		return true;
	    }
	}
	return false;
    }
    
    function ContactName2IDX(name) {
	for(var i in tbContacts) {
	    if (tbContacts[i].Name == name) {
		return i;
	    }
	}
	return -1;
    }
    
    function hasMessage(name, idmsg) {
	var idx = ContactName2IDX(name);
	for (var i in tbContacts[idx].Messages){
	    if (tbContacts[idx].Messages[i].id == idmsg) {
		return true;
	    }
	}
	return false;
    }
    
    function getMessagesToMe() {
	eos.getTableRows({
	    "json": true,
	    "scope": contract_account,
	    "code": contract_account,
	    "table": "notification",
	    "limit": 20,
	    "key_type": "name",
	    "index_position": 2,
	    "lower_bound": accountname,
	}).then(result => {
	    console.log(result);
	    for (var index in result.rows) {
		if (result.rows[index].to == accountname) {
		    console.log("Receiving " + result.rows[index].id);
		    var from = result.rows[index].from;
		    var idmsg = result.rows[index].id;
		    
		    if (!hasContact(from)) {
			var contact = {
			    Name:     from,
			    Messages: [],
			};
			tbContacts.push(contact);
		    }
		    
		    if (!hasMessage(from, idmsg)){
			console.log("read " + from + " " + idmsg);
			
			var idx = ContactName2IDX(from);
			
			tbContacts[idx].Messages.push({
			    id: idmsg,
			    from: from,
			    state: "notify",
			});
		    }
		    
		}
	    };
	    localStorage.setItem("tbContacts", JSON.stringify(tbContacts));
	}).catch(function(exception) {
	    if (exception) {
		alert(exception);
	    }
	});
	
	setTimeout(getMessagesToMe, 5000);
    }
    
    function installDApp(url) {
	$("#barprogress").show();
	$.getJSON(url)
	    .done(function( json ) {
		console.log( json );
		localStorage.setItem(json.key, JSON.stringify(json));
		
		var justInstalled = false;
		for (var i = 0; i < dapps.length; i++) {
		    if (dapps[i] == json.key) {
			justInstalled = true;
		    }
		}
		
		if (! justInstalled) {
		    dapps.push(json.key);                        
		    localStorage.setItem("DApps", JSON.stringify(dapps));
		}
		
		$("#barprogress").hide();
		$("."+json.key).html("Reinstall");
		renderDApps();
	    })
	    .fail(function( jqxhr, textStatus, error ) {
		var err = textStatus + ", " + error;
		console.log( "Request Failed: " + err );
		M.toast({
		    html: 'Request Failed: ' + err
		});
		
		$("#barprogress").hide();
		renderDApps();
	    });
    }

    function addNewDApp () {
	var url = $('#inputNewDApp').val();
	installDApp(url);
    }

    /////////////////////////////////////////////////////////
    //                  API
    /////////////////////////////////////////////////////////
    
    window.addEventListener('signAndPush', function(e) {
	console.log("SignAndPush");
	console.log(e);
	
	$("#actionContract").html(e.detail.action.account);
	$("#actionAction").html(e.detail.action.name);
	$("#actionAuthorization").html(JSON.stringify(e.detail.action.authorization));
	$("#actionData").html(JSON.stringify(e.detail.action.data));
	$("#actionModal").modal("open");
	
	let promisse = new Promise(function(resolve, reject) {
	    $("#btnAcceptAction").unbind();
	    $("#btnAcceptAction").click(function () {
		eos.transaction({actions: [ e.detail.action ]}).then(result => {
		    $("#transferModal").modal("close");
		    resolve(result);
		}).catch(function(exception) {
		    if (exception) {
			reject(Error("Transfer Error"));
		    }
		});
	    });
	});
	
	return  $("iframe")[0].contentWindow.eosaction = promisse;
    });
    
    window.addEventListener('transfer', function(e) {
	$("#transferFrom").html(accountname);
	$("#transferTo").html(e.detail.to);
	$("#transferAmount").html(e.detail.amount);
	$("#transferMemo").html(e.detail.memo);
	$("#transferModal").modal("open");
	
	
	///$("#btnDenyTransfer").click(function () {
	///  $("#transferModal").modal("close");
	///});
	
	let promisse = new Promise(function(resolve, reject) {
	    $("#btnAcceptTransfer").unbind();
	    $("#btnAcceptTransfer").click(function () {
		eos.transfer(accountname, e.detail.to, e.detail.amount, e.detail.memo ).then(result => {
		    $("#transferModal").modal("close");
		    resolve(result);
		}).catch(function(exception) {
		    if (exception) {
			reject(Error("Transfer Error"));
		    }
		});
	    });
	});
	
	return  $("iframe")[0].contentWindow.eostransfer = promisse;
    });
    
    window.addEventListener('adjustIFrameHeight', function(e) {
	$("iframe")[0].style.height = e.detail.height +'px';
    });
    
    window.addEventListener('getCurrentAccount', function(e) {
	return  $("iframe")[0].contentWindow.eosaccountname = accountname;
    });
    
    window.addEventListener('getEOSHttpEndpoint', function(e) {
	return  $("iframe")[0].contentWindow.eoshttpendpoint = eosconfig.httpEndpoint;
    });
    
    window.addEventListener('getEOSChainID', function(e) {
	return  $("iframe")[0].contentWindow.eoschainid = eosconfig.chainId;
    });
    
    window.addEventListener('getPublicKey', function(e) {
	var keypub = localStorage.getItem("keypub");
	return  $("iframe")[0].contentWindow.publickey = keypub;
    });
    
    window.addEventListener('openLink', function(e) {
	var url = e.detail.url;
	var target = e.detail.target;
	
	window.open(url, target);
    });
    
    function stopIFrame() {
	loadContentInIFrame("blank");
    }
    
  </script>
  
</html>
